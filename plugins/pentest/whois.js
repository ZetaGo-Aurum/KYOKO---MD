/**
 * WHOIS Lookup - KYOKO MD Pentest Feature
 * Get WHOIS information for domain
 * Developer: ZetaGo-Aurum
 */

const https = require('https');

const pluginConfig = {
    name: 'whois',
    alias: ['domaininfo', 'lookup'],
    category: 'pentest',
    description: 'WHOIS lookup untuk domain',
    usage: '.whois <domain>',
    example: '.whois example.com',
    isOwner: false,
    isPremium: false,
    isGroup: false,
    isPrivate: false,
    cooldown: 10,
    limit: 0,
    isEnabled: true
};

function fetchUrl(url) {
    return new Promise((resolve, reject) => {
        const req = https.get(url, { headers: { 'User-Agent': 'KYOKO-MD/1.0' } }, (res) => {
            let data = '';
            res.on('data', chunk => data += chunk);
            res.on('end', () => resolve(data));
        });
        req.on('error', reject);
        req.setTimeout(10000, () => {
            req.destroy();
            reject(new Error('Timeout'));
        });
    });
}

async function handler(m, { sock }) {
    const domain = m.text?.trim()?.toLowerCase();
    
    if (!domain) {
        return m.reply(`‚ùå Format: .whois <domain>\n\nContoh: .whois example.com`);
    }
    
    // Validate domain
    if (!/^[a-z0-9]+([\-\.]{1}[a-z0-9]+)*\.[a-z]{2,}$/.test(domain)) {
        return m.reply(`‚ùå Invalid domain format!`);
    }
    
    await m.reply(`üîç *·¥° ú·¥è…™Íú±  ü·¥è·¥è·¥ã·¥ú·¥ò*\n\n‚è≥ Looking up ${domain}...`);
    
    try {
        // Use API for WHOIS
        const data = await fetchUrl(`https://api.hackertarget.com/whois/?q=${domain}`);
        
        if (data.includes('error') || data.length < 50) {
            return m.reply(`‚ùå WHOIS data tidak tersedia untuk domain ini.`);
        }
        
        // Parse important info
        const lines = data.split('\n');
        const info = {};
        
        const importantFields = [
            'Domain Name', 'Registrar', 'Creation Date', 'Updated Date',
            'Expiration Date', 'Name Server', 'Registrant Country'
        ];
        
        lines.forEach(line => {
            importantFields.forEach(field => {
                if (line.toLowerCase().includes(field.toLowerCase() + ':')) {
                    const value = line.split(':').slice(1).join(':').trim();
                    if (value && !info[field]) {
                        info[field] = value;
                    }
                }
            });
        });
        
        let txt = `üîç *·¥° ú·¥è…™Íú±  Ä·¥áÍú±·¥ú ü·¥õ*\n\n`;
        txt += `üåê Domain: \`${domain}\`\n\n`;
        
        if (Object.keys(info).length > 0) {
            Object.entries(info).forEach(([key, value]) => {
                txt += `‚ó¶ ${key}: ${value}\n`;
            });
        } else {
            txt += data.substring(0, 1500);
        }
        
        await m.reply(txt);
        
    } catch (error) {
        await m.reply(`‚ùå Lookup gagal: ${error.message}`);
    }
}

module.exports = { config: pluginConfig, handler };
