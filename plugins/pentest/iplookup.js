/**
 * IP Lookup - KYOKO MD Pentest Feature
 * Get IP geolocation and info
 * Developer: ZetaGo-Aurum
 */

const https = require('https');

const pluginConfig = {
    name: 'iplookup',
    alias: ['ipinfo', 'geoip', 'ip'],
    category: 'pentest',
    description: 'Lookup informasi IP address',
    usage: '.iplookup <ip>',
    example: '.iplookup 8.8.8.8',
    isOwner: false,
    isPremium: false,
    isGroup: false,
    isPrivate: false,
    cooldown: 5,
    limit: 0,
    isEnabled: true
};

function fetchUrl(url) {
    return new Promise((resolve, reject) => {
        const req = https.get(url, { headers: { 'User-Agent': 'KYOKO-MD/1.0' } }, (res) => {
            let data = '';
            res.on('data', chunk => data += chunk);
            res.on('end', () => resolve(data));
        });
        req.on('error', reject);
        req.setTimeout(10000, () => {
            req.destroy();
            reject(new Error('Timeout'));
        });
    });
}

async function handler(m, { sock }) {
    const ip = m.text?.trim();
    
    if (!ip) {
        return m.reply(`‚ùå Format: .iplookup <ip>\n\nContoh: .iplookup 8.8.8.8`);
    }
    
    // Validate IP
    const ipv4Regex = /^(\d{1,3}\.){3}\d{1,3}$/;
    if (!ipv4Regex.test(ip)) {
        return m.reply(`‚ùå Invalid IP format! Contoh: 8.8.8.8`);
    }
    
    try {
        const data = await fetchUrl(`http://ip-api.com/json/${ip}`);
        const info = JSON.parse(data);
        
        if (info.status === 'fail') {
            return m.reply(`‚ùå IP tidak valid atau tidak ditemukan.`);
        }
        
        let txt = `üåê *…™·¥ò  ü·¥è·¥è·¥ã·¥ú·¥ò*\n\n`;
        txt += `üìç IP: \`${info.query}\`\n\n`;
        txt += `‚ó¶ Country: ${info.country} (${info.countryCode})\n`;
        txt += `‚ó¶ Region: ${info.regionName}\n`;
        txt += `‚ó¶ City: ${info.city}\n`;
        txt += `‚ó¶ ZIP: ${info.zip || '-'}\n`;
        txt += `‚ó¶ Timezone: ${info.timezone}\n`;
        txt += `‚ó¶ ISP: ${info.isp}\n`;
        txt += `‚ó¶ Org: ${info.org}\n`;
        txt += `‚ó¶ AS: ${info.as}\n`;
        txt += `‚ó¶ Lat/Lon: ${info.lat}, ${info.lon}\n`;
        
        await m.reply(txt);
        
    } catch (error) {
        await m.reply(`‚ùå Lookup gagal: ${error.message}`);
    }
}

module.exports = { config: pluginConfig, handler };
