/**
 * Technology Detection - KYOKO MD Pentest Feature
 * Detect technologies used by a website (CMS, frameworks, servers)
 * Developer: ZetaGo-Aurum
 */

const https = require('https');
const http = require('http');
const { URL } = require('url');

const pluginConfig = {
    name: 'techdetect',
    alias: ['whatweb', 'builtwith', 'wappalyzer', 'techstack'],
    category: 'pentest',
    description: 'Deteksi teknologi yang digunakan website',
    usage: '.techdetect <url>',
    example: '.techdetect https://example.com',
    isOwner: false,
    isPremium: false,
    isGroup: false,
    isPrivate: false,
    cooldown: 15,
    limit: 0,
    isEnabled: true
};

// Technology signatures
const TECH_SIGNATURES = {
    // CMS
    'WordPress': { headers: ['x-powered-by: wp'], body: ['/wp-content/', '/wp-includes/', 'wp-json', 'wordpress'] },
    'Joomla': { body: ['/components/', '/modules/', '/templates/', 'joomla', '/media/jui/'] },
    'Drupal': { headers: ['x-drupal-cache', 'x-generator: drupal'], body: ['drupal.js', 'drupal.settings'] },
    'Magento': { body: ['/skin/frontend/', 'Mage.Cookies', '/js/varien/', 'magento'] },
    'Shopify': { body: ['shopify', 'cdn.shopify.com', 'myshopify.com'] },
    'Wix': { body: ['wix.com', '_wix_browser_sess', 'wixstatic.com'] },
    
    // Frameworks
    'React': { body: ['_reactRootContainer', 'react-root', '__REACT_DEVTOOLS', 'react.production.min.js'] },
    'Vue.js': { body: ['vue.js', 'vue.min.js', 'v-cloak', '__vue__', 'vue-router'] },
    'Angular': { body: ['ng-version', 'ng-app', 'angular.js', 'angular.min.js', 'ng-controller'] },
    'jQuery': { body: ['jquery', 'jQuery'] },
    'Bootstrap': { body: ['bootstrap.css', 'bootstrap.min.css', 'bootstrap.js'] },
    'Tailwind CSS': { body: ['tailwindcss', 'tailwind.min.css'] },
    'Laravel': { body: ['laravel_session', 'csrf-token', 'laravel/framework'], headers: ['x-powered-by: php'] },
    'Express.js': { headers: ['x-powered-by: express'] },
    'Next.js': { body: ['_next/static', '__NEXT_DATA__', 'next/dist'] },
    'Nuxt.js': { body: ['__NUXT__', 'nuxt', '_nuxt'] },
    
    // Servers
    'Nginx': { headers: ['server: nginx'] },
    'Apache': { headers: ['server: apache'] },
    'LiteSpeed': { headers: ['server: litespeed'] },
    'Cloudflare': { headers: ['server: cloudflare', 'cf-ray'] },
    'IIS': { headers: ['server: microsoft-iis', 'x-powered-by: asp.net'] },
    
    // Languages
    'PHP': { headers: ['x-powered-by: php'], body: ['.php'] },
    'Python': { headers: ['x-powered-by: python', 'server: gunicorn', 'server: waitress'] },
    'Node.js': { headers: ['x-powered-by: express'] },
    'ASP.NET': { headers: ['x-aspnet-version', 'x-powered-by: asp.net'], body: ['__VIEWSTATE', 'aspnetForm'] },
    
    // Analytics & Tools
    'Google Analytics': { body: ['google-analytics.com', 'gtag(', 'googletagmanager.com', 'ga.js', 'analytics.js'] },
    'Google Tag Manager': { body: ['googletagmanager.com/gtm'] },
    'Facebook Pixel': { body: ['connect.facebook.net', 'fbevents.js', 'fbq('] },
    
    // Security
    'reCAPTCHA': { body: ['google.com/recaptcha', 'grecaptcha'] },
    'hCaptcha': { body: ['hcaptcha.com', 'hcaptcha'] },
    'Cloudflare Turnstile': { body: ['challenges.cloudflare.com/turnstile'] }
};

function makeRequest(url, timeout = 10000) {
    return new Promise((resolve) => {
        try {
            const parsedUrl = new URL(url);
            const protocol = parsedUrl.protocol === 'https:' ? https : http;
            
            const req = protocol.get(url, {
                timeout,
                rejectUnauthorized: false,
                headers: { 
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 Chrome/120.0.0.0',
                    'Accept': 'text/html,application/xhtml+xml'
                }
            }, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk.slice(0, 50000)); // Limit to 50KB
                res.on('end', () => resolve({ 
                    status: res.statusCode, 
                    headers: res.headers, 
                    body: data.toLowerCase() 
                }));
            });
            
            req.on('error', () => resolve({ status: 0, error: true }));
            req.on('timeout', () => {
                req.destroy();
                resolve({ status: 0, timeout: true });
            });
        } catch (e) {
            resolve({ status: 0, error: true });
        }
    });
}

async function handler(m, { sock }) {
    let target = m.text?.trim();
    
    if (!target) {
        return m.reply(
            `üî¨ *·¥õ·¥á·¥Ñ ú ·¥Ö·¥á·¥õ·¥á·¥Ñ·¥õ…™·¥è…¥*\n\n` +
            `> Deteksi teknologi website\n\n` +
            `*Penggunaan:*\n` +
            `> ${m.prefix}techdetect <url>\n\n` +
            `*Contoh:*\n` +
            `> ${m.prefix}techdetect https://example.com`
        );
    }
    
    if (!target.startsWith('http://') && !target.startsWith('https://')) {
        target = 'https://' + target;
    }
    
    try {
        new URL(target);
    } catch {
        return m.reply(`‚ùå URL tidak valid!`);
    }
    
    await m.reply(`üî¨ *·¥õ·¥á·¥Ñ ú ·¥Ö·¥á·¥õ·¥á·¥Ñ·¥õ*\n\n‚è≥ Analyzing ${target}...\n> Mohon tunggu...`);
    
    try {
        const result = await makeRequest(target);
        
        if (result.error || result.timeout) {
            return m.reply(`‚ùå Tidak dapat mengakses website!`);
        }
        
        const detected = [];
        const headersStr = JSON.stringify(result.headers).toLowerCase();
        
        for (const [tech, signatures] of Object.entries(TECH_SIGNATURES)) {
            let found = false;
            
            // Check headers
            if (signatures.headers) {
                for (const sig of signatures.headers) {
                    if (headersStr.includes(sig)) {
                        found = true;
                        break;
                    }
                }
            }
            
            // Check body
            if (!found && signatures.body) {
                for (const sig of signatures.body) {
                    if (result.body.includes(sig.toLowerCase())) {
                        found = true;
                        break;
                    }
                }
            }
            
            if (found) {
                detected.push(tech);
            }
        }
        
        // Extract server info
        const server = result.headers['server'] || 'Unknown';
        const poweredBy = result.headers['x-powered-by'] || '';
        
        let txt = `üî¨ *·¥õ·¥á·¥Ñ ú…¥·¥è ü·¥è…¢ è ·¥Ö·¥á·¥õ·¥á·¥Ñ·¥õ…™·¥è…¥*\n\n`;
        txt += `üéØ Target: \`${target}\`\n`;
        txt += `üì° HTTP: ${result.status}\n\n`;
        
        txt += `üñ•Ô∏è *s·¥á Ä·¥†·¥á Ä …™…¥Íú∞·¥è*\n`;
        txt += `‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ\n`;
        txt += `  ‚ó¶ Server: ${server}\n`;
        if (poweredBy) txt += `  ‚ó¶ Powered By: ${poweredBy}\n`;
        txt += `\n`;
        
        if (detected.length > 0) {
            // Categorize detected technologies
            const cms = detected.filter(t => ['WordPress', 'Joomla', 'Drupal', 'Magento', 'Shopify', 'Wix'].includes(t));
            const frameworks = detected.filter(t => ['React', 'Vue.js', 'Angular', 'jQuery', 'Bootstrap', 'Tailwind CSS', 'Laravel', 'Express.js', 'Next.js', 'Nuxt.js'].includes(t));
            const analytics = detected.filter(t => ['Google Analytics', 'Google Tag Manager', 'Facebook Pixel'].includes(t));
            const security = detected.filter(t => ['reCAPTCHA', 'hCaptcha', 'Cloudflare Turnstile', 'Cloudflare'].includes(t));
            const others = detected.filter(t => ![...cms, ...frameworks, ...analytics, ...security].includes(t));
            
            if (cms.length > 0) {
                txt += `üì¶ *·¥Ñ·¥çs*\n`;
                cms.forEach(t => txt += `  ‚ó¶ ${t}\n`);
                txt += `\n`;
            }
            
            if (frameworks.length > 0) {
                txt += `‚ö° *Íú∞ Ä·¥Ä·¥ç·¥á·¥°·¥è Ä·¥ãs*\n`;
                frameworks.forEach(t => txt += `  ‚ó¶ ${t}\n`);
                txt += `\n`;
            }
            
            if (analytics.length > 0) {
                txt += `üìä *·¥Ä…¥·¥Ä ü è·¥õ…™·¥Ñs*\n`;
                analytics.forEach(t => txt += `  ‚ó¶ ${t}\n`);
                txt += `\n`;
            }
            
            if (security.length > 0) {
                txt += `üõ°Ô∏è *s·¥á·¥Ñ·¥ú Ä…™·¥õ è*\n`;
                security.forEach(t => txt += `  ‚ó¶ ${t}\n`);
                txt += `\n`;
            }
            
            if (others.length > 0) {
                txt += `üîß *·¥è·¥õ ú·¥á Ä*\n`;
                others.forEach(t => txt += `  ‚ó¶ ${t}\n`);
                txt += `\n`;
            }
        } else {
            txt += `> Tidak ada teknologi yang terdeteksi.\n`;
        }
        
        txt += `\nüìä Total: ${detected.length} technologies detected`;
        
        await m.reply(txt);
        
    } catch (error) {
        await m.reply(`‚ùå Error: ${error.message}`);
    }
}

module.exports = { config: pluginConfig, handler };
