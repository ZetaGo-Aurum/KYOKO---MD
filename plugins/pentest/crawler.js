/**
 * Website Crawler - KYOKO MD Pentest Feature
 * Crawl and extract links from a website
 * Developer: ZetaGo-Aurum
 */

const https = require('https');
const http = require('http');
const { URL } = require('url');

const pluginConfig = {
    name: 'crawler',
    alias: ['crawl', 'spider', 'links', 'enumerate'],
    category: 'pentest',
    description: 'Crawl dan ekstrak semua link dari website',
    usage: '.crawler <url>',
    example: '.crawler https://example.com',
    isOwner: false,
    isPremium: true,
    isGroup: false,
    isPrivate: false,
    cooldown: 30,
    limit: 1,
    isEnabled: true
};

function makeRequest(url, timeout = 8000) {
    return new Promise((resolve) => {
        try {
            const parsedUrl = new URL(url);
            const protocol = parsedUrl.protocol === 'https:' ? https : http;
            
            const req = protocol.get(url, {
                timeout,
                rejectUnauthorized: false,
                headers: { 
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
                    'Accept': 'text/html,application/xhtml+xml'
                }
            }, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => resolve({ status: res.statusCode, body: data }));
            });
            
            req.on('error', () => resolve({ status: 0, error: true }));
            req.on('timeout', () => {
                req.destroy();
                resolve({ status: 0, timeout: true });
            });
        } catch (e) {
            resolve({ status: 0, error: true });
        }
    });
}

function extractLinks(html, baseUrl) {
    const links = {
        internal: new Set(),
        external: new Set(),
        resources: new Set(),
        forms: new Set(),
        emails: new Set(),
        js: new Set(),
        css: new Set()
    };
    
    const baseOrigin = new URL(baseUrl).origin;
    
    // Extract href links
    const hrefRegex = /href=["']([^"']+)["']/gi;
    let match;
    while ((match = hrefRegex.exec(html)) !== null) {
        try {
            const link = match[1];
            if (link.startsWith('mailto:')) {
                links.emails.add(link.replace('mailto:', ''));
            } else if (link.startsWith('#') || link.startsWith('javascript:')) {
                continue;
            } else if (link.endsWith('.js')) {
                links.js.add(link);
            } else if (link.endsWith('.css')) {
                links.css.add(link);
            } else {
                const fullUrl = new URL(link, baseUrl);
                if (fullUrl.origin === baseOrigin) {
                    links.internal.add(fullUrl.pathname + fullUrl.search);
                } else {
                    links.external.add(fullUrl.href);
                }
            }
        } catch {}
    }
    
    // Extract src links
    const srcRegex = /src=["']([^"']+)["']/gi;
    while ((match = srcRegex.exec(html)) !== null) {
        try {
            const link = match[1];
            if (link.endsWith('.js')) {
                links.js.add(link);
            } else {
                links.resources.add(link);
            }
        } catch {}
    }
    
    // Extract form actions
    const formRegex = /action=["']([^"']+)["']/gi;
    while ((match = formRegex.exec(html)) !== null) {
        try {
            const action = match[1];
            if (!action.startsWith('javascript:')) {
                const fullUrl = new URL(action, baseUrl);
                links.forms.add(fullUrl.pathname + fullUrl.search);
            }
        } catch {}
    }
    
    return links;
}

async function handler(m, { sock }) {
    let target = m.text?.trim();
    
    if (!target) {
        return m.reply(
            `üï∑Ô∏è *·¥°·¥á ôs…™·¥õ·¥á ·¥Ñ Ä·¥Ä·¥° ü·¥á Ä*\n\n` +
            `> Crawl dan ekstrak semua link\n\n` +
            `*Penggunaan:*\n` +
            `> ${m.prefix}crawler <url>\n\n` +
            `*Contoh:*\n` +
            `> ${m.prefix}crawler https://example.com`
        );
    }
    
    if (!target.startsWith('http://') && !target.startsWith('https://')) {
        target = 'https://' + target;
    }
    
    let baseUrl;
    try {
        baseUrl = new URL(target);
    } catch {
        return m.reply(`‚ùå URL tidak valid!`);
    }
    
    await m.reply(`üï∑Ô∏è *·¥Ñ Ä·¥Ä·¥° ü·¥á Ä*\n\n‚è≥ Crawling ${target}...\n> Mohon tunggu...`);
    
    try {
        const mainPage = await makeRequest(target);
        
        if (mainPage.error || mainPage.timeout || !mainPage.body) {
            return m.reply(`‚ùå Tidak dapat mengakses website!`);
        }
        
        const links = extractLinks(mainPage.body, target);
        
        // Crawl a few internal pages to find more links
        const internalPages = Array.from(links.internal).slice(0, 5);
        for (const page of internalPages) {
            try {
                const pageUrl = baseUrl.origin + page;
                const pageResult = await makeRequest(pageUrl, 5000);
                if (pageResult.body) {
                    const pageLinks = extractLinks(pageResult.body, pageUrl);
                    pageLinks.internal.forEach(l => links.internal.add(l));
                    pageLinks.external.forEach(l => links.external.add(l));
                    pageLinks.forms.forEach(l => links.forms.add(l));
                    pageLinks.js.forEach(l => links.js.add(l));
                }
            } catch {}
        }
        
        let txt = `üï∑Ô∏è *·¥Ñ Ä·¥Ä·¥° ü  Ä·¥ás·¥ú ü·¥õ*\n\n`;
        txt += `üéØ Target: \`${baseUrl.origin}\`\n`;
        txt += `üìÑ Pages crawled: ${internalPages.length + 1}\n\n`;
        
        // Internal links
        if (links.internal.size > 0) {
            txt += `üìÅ *…™…¥·¥õ·¥á Ä…¥·¥Ä ü  ü…™…¥·¥ãs* (${links.internal.size})\n`;
            txt += `‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ\n`;
            const internalArr = Array.from(links.internal).slice(0, 15);
            internalArr.forEach(l => txt += `  ‚ó¶ ${l}\n`);
            if (links.internal.size > 15) txt += `  ... dan ${links.internal.size - 15} lainnya\n`;
            txt += `\n`;
        }
        
        // Forms
        if (links.forms.size > 0) {
            txt += `üìù *Íú∞·¥è Ä·¥ç ·¥Ä·¥Ñ·¥õ…™·¥è…¥s* (${links.forms.size})\n`;
            txt += `‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ\n`;
            Array.from(links.forms).slice(0, 10).forEach(l => txt += `  ‚ó¶ ${l}\n`);
            txt += `\n`;
        }
        
        // JavaScript files
        if (links.js.size > 0) {
            txt += `üìú *·¥ä·¥Ä·¥†·¥Äs·¥Ñ Ä…™·¥ò·¥õ Íú∞…™ ü·¥ás* (${links.js.size})\n`;
            txt += `‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ\n`;
            Array.from(links.js).slice(0, 8).forEach(l => {
                const filename = l.split('/').pop().split('?')[0];
                txt += `  ‚ó¶ ${filename}\n`;
            });
            txt += `\n`;
        }
        
        // External links
        if (links.external.size > 0) {
            txt += `üåê *·¥áx·¥õ·¥á Ä…¥·¥Ä ü  ü…™…¥·¥ãs* (${links.external.size})\n`;
            txt += `‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ\n`;
            Array.from(links.external).slice(0, 8).forEach(l => {
                try {
                    txt += `  ‚ó¶ ${new URL(l).hostname}\n`;
                } catch {}
            });
            txt += `\n`;
        }
        
        // Emails
        if (links.emails.size > 0) {
            txt += `üìß *·¥á·¥ç·¥Ä…™ üs* (${links.emails.size})\n`;
            txt += `‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ‚îÑ\n`;
            Array.from(links.emails).slice(0, 5).forEach(e => txt += `  ‚ó¶ ${e}\n`);
            txt += `\n`;
        }
        
        // Summary
        const total = links.internal.size + links.external.size + links.forms.size;
        txt += `üìä *Total:* ${total} unique links found`;
        
        await m.reply(txt);
        
    } catch (error) {
        await m.reply(`‚ùå Error: ${error.message}`);
    }
}

module.exports = { config: pluginConfig, handler };
